<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Management Platform - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-card .number {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-card.critical .number { 
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-card.warning .number { 
            background: linear-gradient(45deg, #f39c12, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-card.success .number { 
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-card.info .number { 
            background: linear-gradient(45deg, #3498db, #2980b9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Enhanced Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
            min-width: 140px;
            position: relative;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            position: relative;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            padding-bottom: 15px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        /* Enhanced Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn.primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .action-btn.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .action-btn.warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .action-btn.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .action-btn.info {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .action-btn:active {
            transform: translateY(-1px);
        }

        /* Enhanced Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table th {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover {
            background: linear-gradient(45deg, #f8f9fa, #f1f3f4);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Priority and Status badges */
        .priority-badge, .status-badge, .type-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .priority-critical { background: #ffe6e6; color: #c0392b; }
        .priority-high { background: #fff3e0; color: #d68910; }
        .priority-medium { background: #fff9e6; color: #b7950b; }
        .priority-low { background: #e8f5e8; color: #27ae60; }

        .status-open { background: #e3f2fd; color: #1976d2; }
        .status-resolved { background: #e8f5e8; color: #27ae60; }
        .status-pending { background: #fff3e0; color: #d68910; }
        .status-sending { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-cancelled { background: #f8f9fa; color: #6c757d; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }

        .type-community { background: #cce5ff; color: #004085; }
        .type-emergency { background: #f8d7da; color: #721c24; }
        .type-announcements { background: #fff3cd; color: #856404; }
        .type-healthcare { background: #d1ecf1; color: #0c5460; }
        .type-infrastructure { background: #d4edda; color: #155724; }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* Scheduling specific styles */
        .scheduling-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 10px;
        }

        .schedule-info {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search and filters */
        .search-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .filter-group {
            min-width: 150px;
        }

        /* Health Score Display */
        .health-score {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .health-excellent { background: #d4edda; color: #155724; }
        .health-good { background: #cce5ff; color: #004085; }
        .health-fair { background: #fff3cd; color: #856404; }
        .health-poor { background: #f8d7da; color: #721c24; }

        /* Loading states */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 20px;
            }

            .search-filters {
                flex-direction: column;
            }

            .data-table {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📱 WhatsApp Management Platform</h1>
            <p>Enhanced messaging analysis, group management, and advanced analytics</p>
        </div>

        <!-- Enhanced Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card info">
                <div class="number" id="totalMessages">Loading...</div>
                <div class="label">Total Messages</div>
            </div>
            <div class="stat-card warning">
                <div class="number" id="flaggedMessages">Loading...</div>
                <div class="label">Flagged Messages</div>
            </div>
            <div class="stat-card critical">
                <div class="number" id="criticalMessages">Loading...</div>
                <div class="label">Critical Messages</div>
            </div>
            <div class="stat-card success">
                <div class="number" id="openTickets">Loading...</div>
                <div class="label">Open Tickets</div>
            </div>
            <div class="stat-card info">
                <div class="number" id="pendingScheduled">Loading...</div>
                <div class="label">Pending Scheduled</div>
            </div>
            <div class="stat-card primary">
                <div class="number" id="totalGroups">Loading...</div>
                <div class="label">Total Groups</div>
            </div>
            <div class="stat-card success">
                <div class="number" id="activeGroups">Loading...</div>
                <div class="label">Active Groups</div>
            </div>
            <div class="stat-card info">
                <div class="number" id="totalMembers">Loading...</div>
                <div class="label">Total Members</div>
            </div>
        </div>

        <!-- Enhanced Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="showSection('messages')">💬 Messages</button>
            <button class="nav-tab" onclick="showSection('tickets')">🎫 Tickets</button>
            <button class="nav-tab" onclick="showSection('groups')">👥 Groups</button>
            <button class="nav-tab" onclick="showSection('analytics')">📈 Analytics</button>
            <button class="nav-tab" onclick="showSection('bulk')">📢 Bulk Messages</button>
            <button class="nav-tab" onclick="showSection('scheduled')">⏰ Scheduled</button>
	   <button class="nav-tab" onclick="window.open('/sensitivity', '_blank')">🎛️ AI Sensitivity </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <h2 class="section-title">🚨 Recent Flagged Messages</h2>
            <div id="recentFlagged">Loading recent flagged messages...</div>

            <h2 class="section-title">⚡ Quick Actions</h2>
            <div class="quick-actions">
                <button class="action-btn primary" onclick="window.open('/', '_blank')">
                    📊 View Sentiment Analysis
                </button>
                <button class="action-btn success" onclick="refreshData()">
                    🔄 Refresh Data
                </button>
                <button class="action-btn warning" onclick="showBulkMessageModal()">
                    📢 Send Bulk Message
                </button>
                <button class="action-btn info" onclick="showTestMessageModal()">
                    🧪 Test Message Analysis
                </button>
                <button class="action-btn primary" onclick="showCreateGroupModal()">
                    👥 Create Group
                </button>
                <button class="action-btn success" onclick="viewGroupsLeaderboard()">
                    🏆 Groups Leaderboard
                </button>
            </div>

            <!-- Analytics Summary -->
            <h2 class="section-title">📈 Analytics Summary</h2>
            <div id="analyticsSummary">Loading analytics...</div>
        </div>

        <!-- Messages Section -->
        <div id="messages" class="content-section">
            <h2 class="section-title">💬 Message Analysis</h2>
            <div class="form-group">
                <label for="testMessage">Test Message Flagging:</label>
                <textarea id="testMessage" class="form-control" placeholder="Enter a message to test the flagging system..."></textarea>
                <button class="action-btn primary" onclick="testMessage()" style="margin-top: 10px;">
                    🔍 Analyze Message
                </button>
            </div>
            <div id="messageTestResult"></div>
        </div>

        <!-- Tickets Section -->
        <div id="tickets" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title">🎫 Ticket Management</h2>
                <button class="action-btn primary" onclick="showCreateTicketModal()">
                    ➕ Create Ticket
                </button>
            </div>
            <div id="ticketsList">Loading tickets...</div>
        </div>

        <!-- Groups Section -->
        <div id="groups" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title">👥 Group Management</h2>
                <button class="action-btn primary" onclick="showCreateGroupModal()">
                    ➕ Create Group
                </button>
            </div>
            
            <!-- Search and Filters -->
            <div class="search-filters">
                <div class="search-box">
                    <label for="groupSearch">Search Groups</label>
                    <input type="text" id="groupSearch" class="form-control" placeholder="Search by name, description..." onkeyup="searchGroups()">
                </div>
                <div class="filter-group">
                    <label for="typeFilter">Filter by Type</label>
                    <select id="typeFilter" class="form-control" onchange="filterGroups()">
                        <option value="">All Types</option>
                        <option value="community">Community</option>
                        <option value="emergency">Emergency</option>
                        <option value="announcements">Announcements</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="infrastructure">Infrastructure</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Filter by Status</label>
                    <select id="statusFilter" class="form-control" onchange="filterGroups()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="action-btn primary" onclick="refreshGroups()">🔄 Refresh</button>
                </div>
            </div>

            <!-- Groups Table -->
            <div id="groupsTable" style="overflow-x: auto;">
                Loading groups...
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="content-section">
            <h2 class="section-title">📈 Advanced Analytics</h2>
            
            <div class="form-group">
                <label for="analyticsGroupSelect">Select Group for Analysis</label>
                <select id="analyticsGroupSelect" class="form-control" onchange="loadGroupAnalytics()">
                    <option value="">Select a group...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="analyticsTimeframe">Timeframe</label>
                <select id="analyticsTimeframe" class="form-control" onchange="loadGroupAnalytics()">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>

            <div id="analyticsContent">
                Select a group to view analytics
            </div>
        </div>

        <!-- Bulk Messages Section -->
        <div id="bulk" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title">📢 Bulk Message History</h2>
                <button class="action-btn primary" onclick="showBulkMessageModal()">
                    📤 Send New Message
                </button>
            </div>
            <div id="bulkMessageHistory">Loading bulk message history...</div>
        </div>

        <!-- Scheduled Messages Section -->
        <div id="scheduled" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title">⏰ Scheduled Messages</h2>
                <button class="action-btn primary" onclick="showBulkMessageModal()">
                    📅 Schedule New Message
                </button>
            </div>
            <div id="scheduledMessagesList">Loading scheduled messages...</div>
        </div>
    </div>

    <!-- Enhanced Bulk Message Modal with Scheduling -->
    <div id="bulkMessageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBulkMessageModal()">&times;</span>
            <h2>📢 Send Bulk Message</h2>
            <form id="bulkMessageForm">
                <div class="form-group">
                    <label for="bulkMessage">Message:</label>
                    <textarea id="bulkMessage" class="form-control" rows="4" placeholder="Enter your message here..." required></textarea>
                    <small class="text-muted">Character count: <span id="charCount">0</span>/1000</small>
                </div>

                <!-- Scheduling Section -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="scheduleToggle" onchange="toggleScheduling()">
                        <span>📅 Schedule for later</span>
                    </label>
                </div>

                <div id="schedulingSection" class="scheduling-section" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="scheduleDate">Date:</label>
                            <input type="date" id="scheduleDate" class="form-control" min="">
                        </div>
                        <div class="form-group">
                            <label for="scheduleTime">Time:</label>
                            <input type="time" id="scheduleTime" class="form-control">
                        </div>
                    </div>
                    <div class="schedule-info" id="scheduleInfo" style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 10px; display: none;">
                        <small><i class="fas fa-clock me-1"></i><span id="schedulePreview"></span></small>
                    </div>
                </div>

                <!-- Target Selection -->
                <div class="form-group">
                    <label>Select Target Groups:</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 8px;" id="groupsSelection">
                        Loading groups...
                    </div>
                    <small class="text-muted">Total selected recipients: <span id="totalRecipients">0</span></small>
                </div>

                <!-- WhatsApp API Options -->
                <div class="form-group">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="useWhatsAppAPI" checked>
                            <span>📱 Use WhatsApp Business API</span>
                        </label>
                        <small class="text-muted">Enable for real message delivery with tracking and compliance</small>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" class="action-btn warning" onclick="previewMessage()" style="flex: 1;">
                        👁️ Preview
                    </button>
                    <button type="submit" class="action-btn primary" style="flex: 2;">
                        <span id="sendButtonText">📤 Send Now</span>
                    </button>
                </div>
            </form>

            <!-- Preview Section -->
            <div id="messagePreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h5>📱 Message Preview:</h5>
                <div id="previewContent" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #25D366;"></div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateGroupModal()">&times;</span>
            <h2>👥 Create New Group</h2>
            <form id="createGroupForm">
                <div class="form-group">
                    <label for="groupName">Group Name *</label>
                    <input type="text" id="groupName" class="form-control" required placeholder="Enter group name">
                </div>
                
                <div class="form-group">
                    <label for="groupType">Group Type *</label>
                    <select id="groupType" class="form-control" required>
                        <option value="">Select Type</option>
                        <option value="community">Community</option>
                        <option value="emergency">Emergency</option>
                        <option value="announcements">Announcements</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="support">Support</option>
                        <option value="feedback">Feedback</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="groupConstituency">Constituency</label>
                    <input type="text" id="groupConstituency" class="form-control" placeholder="e.g., North Bangalore">
                </div>
                
                <div class="form-group">
                    <label for="groupRegion">Region</label>
                    <input type="text" id="groupRegion" class="form-control" placeholder="e.g., Karnataka">
                </div>
                
                <div class="form-group">
                    <label for="groupDescription">Description *</label>
                    <textarea id="groupDescription" class="form-control" rows="3" required placeholder="Enter group description"></textarea>
                </div>
                
                <button type="submit" class="action-btn primary" style="width: 100%; margin-top: 20px;">
                    ➕ Create Group
                </button>
            </form>
        </div>
    </div>

    <!-- Create Ticket Modal -->
    <div id="createTicketModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateTicketModal()">&times;</span>
            <h2>🎫 Create New Ticket</h2>
            <form id="createTicketForm">
                <div class="form-group">
                    <label for="ticketTitle">Title:</label>
                    <input type="text" id="ticketTitle" class="form-control" placeholder="Brief description of the issue" required>
                </div>
                <div class="form-group">
                    <label for="ticketMessage">Description:</label>
                    <textarea id="ticketMessage" class="form-control" rows="4" placeholder="Detailed description of the issue" required></textarea>
                </div>
                <div class="form-group">
                    <label for="ticketPriority">Priority:</label>
                    <select id="ticketPriority" class="form-control">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                        <option value="CRITICAL">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ticketSender">Reporter:</label>
                    <input type="text" id="ticketSender" class="form-control" placeholder="Name of the person reporting" required>
                </div>
                <button type="submit" class="action-btn primary" style="width: 100%; margin-top: 20px;">
                    🎫 Create Ticket
                </button>
            </form>
        </div>
    </div>

    <!-- Test Message Modal -->
    <div id="testMessageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTestMessageModal()">&times;</span>
            <h2>🧪 Test Message Analysis</h2>
            <form id="testMessageForm">
                <div class="form-group">
                    <label for="testMessageText">Message:</label>
                    <textarea id="testMessageText" class="form-control" rows="3" placeholder="Enter a message to test..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="testSender">Sender:</label>
                    <input type="text" id="testSender" class="form-control" placeholder="Sender name" value="Test User">
                </div>
                <button type="submit" class="action-btn primary" style="width: 100%; margin-top: 20px;">
                    🔍 Analyze Message
                </button>
            </form>
            <div id="testMessageResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Group Details Modal -->
    <div id="groupDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGroupDetailsModal()">&times;</span>
            <h2 id="groupDetailsTitle">Group Details</h2>
            <div id="groupDetailsContent">
                <!-- Group details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = {};
        let currentGroups = [];
        let selectedGroupId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadEnhancedDashboardStats();
            loadRecentFlagged();
            loadTickets();
            loadBulkMessageHistory();
            loadScheduledMessages();
            loadAnalyticsSummary();
            loadGroups();
            loadGroupOptions();
        });

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load data for specific sections
            if (sectionName === 'tickets') {
                loadTickets();
            } else if (sectionName === 'bulk') {
                loadBulkMessageHistory();
            } else if (sectionName === 'scheduled') {
                loadScheduledMessages();
            } else if (sectionName === 'groups') {
                loadGroups();
            } else if (sectionName === 'analytics') {
                loadGroupOptions();
            }
        }

        // Enhanced Dashboard Stats
        async function loadEnhancedDashboardStats() {
            try {
                const response = await fetch('/api/dashboard_stats_enhanced');
                const data = await response.json();
                
                document.getElementById('totalMessages').textContent = data.total_messages || 0;
                document.getElementById('flaggedMessages').textContent = data.flagged_messages || 0;
                document.getElementById('criticalMessages').textContent = data.critical_messages || 0;
                document.getElementById('openTickets').textContent = data.open_tickets || 0;
                document.getElementById('pendingScheduled').textContent = data.pending_scheduled || 0;
                document.getElementById('totalGroups').textContent = data.total_groups || 0;
                document.getElementById('activeGroups').textContent = data.active_groups || 0;
                document.getElementById('totalMembers').textContent = data.total_group_members || 0;
                
                currentData.stats = data;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Set defaults
                document.getElementById('totalMessages').textContent = '0';
                document.getElementById('flaggedMessages').textContent = '0';
                document.getElementById('criticalMessages').textContent = '0';
                document.getElementById('openTickets').textContent = '0';
                document.getElementById('pendingScheduled').textContent = '0';
                document.getElementById('totalGroups').textContent = '0';
                document.getElementById('activeGroups').textContent = '0';
                document.getElementById('totalMembers').textContent = '0';
            }
        }

        // Recent Flagged Messages
        async function loadRecentFlagged() {
            try {
                const response = await fetch('/api/recent_flagged');
                const flagged = await response.json();
                
                const container = document.getElementById('recentFlagged');
                
                if (flagged.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">😌</div>
                            <p>No flagged messages found. The system is monitoring for sensitive content.</p>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Message</th>
                                <th>Sender</th>
                                <th>Priority</th>
                                <th>Category</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${flagged.map(msg => `
                                <tr>
                                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${msg.message}</td>
                                    <td>${msg.sender}</td>
                                    <td><span class="priority-badge priority-${msg.priority.toLowerCase()}">${msg.priority}</span></td>
                                    <td>${msg.category}</td>
                                    <td>${msg.timestamp}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading recent flagged:', error);
                document.getElementById('recentFlagged').innerHTML = '<p>Error loading flagged messages.</p>';
            }
        }

        // Tickets Management
        async function loadTickets() {
            try {
                const response = await fetch('/api/tickets');
                const tickets = await response.json();
                
                const container = document.getElementById('ticketsList');
                
                if (tickets.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">🎫</div>
                            <p>No tickets found. Create a ticket or analyze messages to generate automatic tickets.</p>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tickets.map(ticket => `
                                <tr>
                                    <td><strong>${ticket.id}</strong></td>
                                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${ticket.title}</td>
                                    <td>${ticket.category}</td>
                                    <td><span class="priority-badge priority-${ticket.priority.toLowerCase()}">${ticket.priority}</span></td>
                                    <td><span class="status-badge status-${ticket.status.toLowerCase()}">${ticket.status}</span></td>
                                    <td>${ticket.assigned_to}</td>
                                    <td>${new Date(ticket.created_at).toLocaleDateString()}</td>
                                    <td>
                                        ${ticket.status === 'OPEN' ? 
                                            `<button class="action-btn success" onclick="updateTicketStatus('${ticket.id}', 'RESOLVED')" style="padding: 5px 10px; font-size: 0.8rem;">✅ Resolve</button>` :
                                            `<span style="color: #27ae60;">✅ Resolved</span>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsList').innerHTML = '<p>Error loading tickets.</p>';
            }
        }

        // Update ticket status
        async function updateTicketStatus(ticketId, status) {
            try {
                const response = await fetch(`/api/tickets/${ticketId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: status })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadTickets(); // Reload tickets
                    loadEnhancedDashboardStats(); // Update stats
                } else {
                    alert('Error updating ticket status');
                }
            } catch (error) {
                console.error('Error updating ticket:', error);
                alert('Error updating ticket status');
            }
        }

        // Groups Management
        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                const data = await response.json();
                
                if (data.success) {
                    currentGroups = data.groups;
                    displayGroups(currentGroups);
                    loadGroupsForBulkMessage(); // Update bulk message groups
                }
            } catch (error) {
                console.error('Error loading groups:', error);
                document.getElementById('groupsTable').innerHTML = '<p>Error loading groups</p>';
            }
        }

        // Display groups in table
        function displayGroups(groups) {
            const tableContainer = document.getElementById('groupsTable');
            
            if (groups.length === 0) {
                tableContainer.innerHTML = '<p>No groups found</p>';
                return;
            }

            const html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Members</th>
                            <th>Constituency</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${groups.map(group => `
                            <tr>
                                <td>
                                    <strong>${group.name}</strong>
                                    <br><small style="color: #666;">${group.description}</small>
                                </td>
                                <td><span class="type-badge type-${group.type}">${group.type}</span></td>
                                <td><span class="status-badge status-${group.status}">${group.status}</span></td>
                                <td>${group.member_count}</td>
                                <td>${group.constituency || '-'}</td>
                                <td>${new Date(group.created_date).toLocaleDateString()}</td>
                                <td>
                                    <button class="action-btn primary" onclick="viewGroupDetails('${group.group_id}')" style="padding: 5px 10px; font-size: 0.8rem;">👁️ View</button>
                                    <button class="action-btn success" onclick="viewGroupAnalytics('${group.group_id}')" style="padding: 5px 10px; font-size: 0.8rem;">📊 Analytics</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = html;
        }

        // Search and filter functions for groups
        function searchGroups() {
            const query = document.getElementById('groupSearch').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredGroups = currentGroups.filter(group => {
                const matchesSearch = group.name.toLowerCase().includes(query) || 
                                    group.description.toLowerCase().includes(query);
                const matchesType = !typeFilter || group.type === typeFilter;
                const matchesStatus = !statusFilter || group.status === statusFilter;
                
                return matchesSearch && matchesType && matchesStatus;
            });
            
            displayGroups(filteredGroups);
        }

        function filterGroups() {
            searchGroups(); // Reuse search logic
        }

        function refreshGroups() {
            loadGroups();
            loadEnhancedDashboardStats();
        }

        // Group details
        async function viewGroupDetails(groupId) {
            try {
                const response = await fetch(`/api/groups/${groupId}`);
                const data = await response.json();
                
                if (data.success) {
                    const group = data.group;
                    
                    document.getElementById('groupDetailsTitle').textContent = group.name;
                    
                    const html = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div>
                                <h4>Basic Information</h4>
                                <p><strong>Description:</strong> ${group.description}</p>
                                <p><strong>Type:</strong> ${group.type}</p>
                                <p><strong>Status:</strong> ${group.status}</p>
                                <p><strong>Created:</strong> ${new Date(group.created_date).toLocaleString()}</p>
                            </div>
                            <div>
                                <h4>Location</h4>
                                <p><strong>Constituency:</strong> ${group.constituency || 'Not specified'}</p>
                                <p><strong>Region:</strong> ${group.region || 'Not specified'}</p>
                            </div>
                            <div>
                                <h4>Members</h4>
                                <p><strong>Total Members:</strong> ${group.member_count}</p>
                                <p><strong>Max Members:</strong> ${group.settings?.max_members || 'Not set'}</p>
                            </div>
                            <div>
                                <h4>Settings</h4>
                                <p><strong>Auto Response:</strong> ${group.settings?.auto_response_enabled ? 'Enabled' : 'Disabled'}</p>
                                <p><strong>Content Filtering:</strong> ${group.settings?.content_filtering ? 'Enabled' : 'Disabled'}</p>
                            </div>
                        </div>
                        
                        ${group.statistics && !group.statistics.error ? `
                        <div style="margin-top: 20px;">
                            <h4>Statistics</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="stat-card">
                                    <div class="number">${group.statistics.member_stats?.total_members || 0}</div>
                                    <div class="label">Total Members</div>
                                </div>
                                <div class="stat-card">
                                    <div class="number">${group.statistics.activity_stats?.total_messages || 0}</div>
                                    <div class="label">Total Messages</div>
                                </div>
                                <div class="stat-card">
                                    <div class="number">${Math.round(group.statistics.activity_stats?.avg_messages_per_member || 0)}</div>
                                    <div class="label">Avg Messages/Member</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    `;
                    
                    document.getElementById('groupDetailsContent').innerHTML = html;
                    document.getElementById('groupDetailsModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading group details:', error);
                alert('Error loading group details');
            }
        }

        // View group analytics
        function viewGroupAnalytics(groupId) {
            document.getElementById('analyticsGroupSelect').value = groupId;
            showSection('analytics');
            setTimeout(() => {
                document.querySelector('.nav-tab[onclick="showSection(\'analytics\')"]').classList.add('active');
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab !== document.querySelector('.nav-tab[onclick="showSection(\'analytics\')"]')) {
                        tab.classList.remove('active');
                    }
                });
                loadGroupAnalytics();
            }, 100);
        }

        // Load group options for dropdowns
        async function loadGroupOptions() {
            try {
                const response = await fetch('/api/groups');
                const data = await response.json();
                
                if (data.success) {
                    const groups = data.groups;
                    
                    // Update analytics dropdown
                    const analyticsSelect = document.getElementById('analyticsGroupSelect');
                    analyticsSelect.innerHTML = '<option value="">Select a group...</option>';
                    
                    groups.forEach(group => {
                        const option = new Option(group.name, group.group_id);
                        analyticsSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading group options:', error);
            }
        }

        // Load groups for bulk message selection
        async function loadGroupsForBulkMessage() {
            try {
                const response = await fetch('/api/groups');
                const data = await response.json();
                
                if (data.success) {
                    const groups = data.groups;
                    const container = document.getElementById('groupsSelection');
                    
                    if (groups.length === 0) {
                        container.innerHTML = '<p>No groups available. Create groups first.</p>';
                        return;
                    }
                    
                    const html = groups.map(group => `
                        <label>
                            <input type="checkbox" value="${group.group_id}" onchange="updateTotalRecipients()"> 
                            <span style="margin-left: 8px;">${getGroupIcon(group.type)} ${group.name} <small>(${group.member_count} members)</small></span>
                        </label>
                    `).join('');
                    
                    container.innerHTML = html;
                    updateTotalRecipients();
                }
            } catch (error) {
                console.error('Error loading groups for bulk message:', error);
                document.getElementById('groupsSelection').innerHTML = '<p>Error loading groups</p>';
            }
        }

        function getGroupIcon(type) {
            const icons = {
                'community': '🏘️',
                'emergency': '🚨',
                'announcements': '📢',
                'healthcare': '🏥',
                'infrastructure': '🚧',
                'support': '🤝',
                'feedback': '💭'
            };
            return icons[type] || '👥';
        }

        // Analytics functions
        async function loadGroupAnalytics() {
            const groupId = document.getElementById('analyticsGroupSelect').value;
            const timeframe = document.getElementById('analyticsTimeframe').value;
            
            if (!groupId) {
                document.getElementById('analyticsContent').innerHTML = 'Select a group to view analytics';
                return;
            }
            
            document.getElementById('analyticsContent').innerHTML = '<div class="loading"></div> Loading analytics...';
            
            try {
                // Load health score
                const healthResponse = await fetch(`/api/analytics/health/${groupId}?timeframe=${timeframe}`);
                const healthData = await healthResponse.json();
                
                // Load trends
                const trendsResponse = await fetch(`/api/analytics/trends?group_id=${groupId}&timeframe=${timeframe}`);
                const trendsData = await trendsResponse.json();
                
                if (healthData.success && trendsData.success) {
                    displayGroupAnalytics(healthData.health_data, trendsData.trends);
                } else {
                    document.getElementById('analyticsContent').innerHTML = 'Error loading analytics';
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('analyticsContent').innerHTML = 'Error loading analytics';
            }
        }

        function displayGroupAnalytics(healthData, trendsData) {
            const healthScore = healthData.health_score || 0;
            const components = healthData.components || {};
            
            let healthClass = 'health-poor';
            if (healthScore >= 80) healthClass = 'health-excellent';
            else if (healthScore >= 60) healthClass = 'health-good';
            else if (healthScore >= 40) healthClass = 'health-fair';
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="health-score ${healthClass}">
                            <span style="font-size: 2rem; font-weight: bold;">${healthScore}</span>
                            <span>Health Score</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${Math.round(components.activity_score || 0)}</div>
                        <div class="label">Activity Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${Math.round(components.sentiment_score || 0)}</div>
                        <div class="label">Sentiment Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">${Math.round(components.safety_score || 0)}</div>
                        <div class="label">Safety Score</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h4>Health Components</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            ${Object.entries(components).map(([key, value]) => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>${key.replace('_', ' ').toUpperCase()}:</span>
                                    <span style="font-weight: bold; color: ${value >= 70 ? '#27ae60' : value >= 50 ? '#f39c12' : '#e74c3c'};">${Math.round(value)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4>Recommendations</h4>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            ${(healthData.recommendations || []).map(rec => `
                                <div style="margin-bottom: 10px;">• ${rec}</div>
                            `).join('') || '<div>No specific recommendations at this time.</div>'}
                        </div>
                    </div>
                </div>
                
                ${trendsData && trendsData.trends ? `
                <div style="margin-top: 30px;">
                    <h4>Trends Analysis</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        ${trendsData.trends.message_volume_trend ? `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h5>Message Volume</h5>
                            <p><strong>Trend:</strong> ${trendsData.trends.message_volume_trend.trend}</p>
                            <p><strong>Daily Average:</strong> ${Math.round(trendsData.trends.message_volume_trend.daily_average || 0)}</p>
                        </div>
                        ` : ''}
                        
                        ${trendsData.trends.sentiment_trend ? `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h5>Sentiment Trend</h5>
                            <p><strong>Direction:</strong> ${trendsData.trends.sentiment_trend.trend}</p>
                            <p><strong>Positive Ratio:</strong> ${Math.round((trendsData.trends.sentiment_trend.current_positive_ratio || 0) * 100)}%</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('analyticsContent').innerHTML = html;
        }

        // Bulk Message History
        async function loadBulkMessageHistory() {
            try {
                const response = await fetch('/api/bulk_messages');
                const messages = await response.json();
                
                const container = document.getElementById('bulkMessageHistory');
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">📢</div>
                            <p>No bulk messages sent yet. Use the "Send New Message" button to send your first bulk message.</p>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Message Preview</th>
                                <th>Groups</th>
                                <th>Status</th>
                                <th>Sent</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(msg => `
                                <tr>
                                    <td><strong>${msg.id}</strong></td>
                                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${msg.message}</td>
                                    <td>${msg.group_count || msg.recipient_count || 0} groups</td>
                                    <td><span class="status-badge status-${msg.status.toLowerCase()}">${msg.status}</span></td>
                                    <td>${msg.sent_count}/${msg.sent_count + (msg.failed_count || 0)}</td>
                                    <td>${new Date(msg.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading bulk messages:', error);
                document.getElementById('bulkMessageHistory').innerHTML = '<p>Error loading bulk message history.</p>';
            }
        }

        // Load Scheduled Messages
        async function loadScheduledMessages() {
            try {
                const response = await fetch('/api/scheduled_messages');
                const messages = await response.json();
                
                const container = document.getElementById('scheduledMessagesList');
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">⏰</div>
                            <p>No scheduled messages found. Use the "Schedule New Message" button to schedule your first message.</p>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Message Preview</th>
                                <th>Targets</th>
                                <th>Scheduled For</th>
                                <th>Status</th>
                                <th>Time Remaining</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(msg => `
                                <tr>
                                    <td><strong>${msg.id}</strong></td>
                                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${msg.message}</td>
                                    <td>${msg.total_targets} targets</td>
                                    <td>${new Date(msg.scheduled_for).toLocaleString()}</td>
                                    <td><span class="status-badge status-${msg.status}">${msg.status.toUpperCase()}</span></td>
                                    <td>${msg.time_remaining || '-'}</td>
                                    <td>
                                        ${msg.status === 'pending' ? 
                                            `<button class="action-btn warning" onclick="cancelScheduledMessage('${msg.id}')" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">❌ Cancel</button>` :
                                            `<span style="color: #666;">No actions</span>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading scheduled messages:', error);
                document.getElementById('scheduledMessagesList').innerHTML = '<p>Error loading scheduled messages.</p>';
            }
        }

        // Analytics Summary
        async function loadAnalyticsSummary() {
            try {
                const response = await fetch('/api/analytics/summary');
                const data = await response.json();
                
                const container = document.getElementById('analyticsSummary');
                
                const html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="stat-card">
                            <div class="number">${data.flagged_percentage || 0}%</div>
                            <div class="label">Messages Flagged</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${Object.keys(data.sentiment_distribution || {}).length}</div>
                            <div class="label">Sentiment Types</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${Object.keys(data.language_distribution || {}).length}</div>
                            <div class="label">Languages Detected</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${data.resolved_tickets || 0}</div>
                            <div class="label">Resolved Tickets</div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('analyticsSummary').innerHTML = '<p>Error loading analytics summary.</p>';
            }
        }

        // Groups Leaderboard
        async function viewGroupsLeaderboard() {
            try {
                const response = await fetch('/api/analytics/leaderboard?metric=health_score&limit=10');
                const data = await response.json();
                
                if (data.success) {
                    const leaderboard = data.leaderboard;
                    
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'block';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                            <h2>🏆 Groups Leaderboard - Health Score</h2>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Group Name</th>
                                        <th>Type</th>
                                        <th>Health Score</th>
                                        <th>Members</th>
                                        <th>Constituency</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${leaderboard.map((group, index) => `
                                        <tr>
                                            <td><strong>#${index + 1}</strong></td>
                                            <td>${group.group_name}</td>
                                            <td><span class="type-badge type-${group.group_type}">${group.group_type}</span></td>
                                            <td>
                                                <span class="health-score ${group.score >= 80 ? 'health-excellent' : group.score >= 60 ? 'health-good' : group.score >= 40 ? 'health-fair' : 'health-poor'}">
                                                    ${group.score}
                                                </span>
                                            </td>
                                            <td>${group.member_count}</td>
                                            <td>${group.constituency || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                alert('Error loading groups leaderboard');
            }
        }

        // Scheduling Functions
        function toggleScheduling() {
            const toggle = document.getElementById('scheduleToggle');
            const section = document.getElementById('schedulingSection');
            const sendButton = document.getElementById('sendButtonText');
            const scheduleInfo = document.getElementById('scheduleInfo');
            
            if (toggle.checked) {
                section.style.display = 'block';
                sendButton.textContent = '⏰ Schedule Message';
                
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('scheduleDate').min = today;
                
                // Set default time to 1 hour from now
                const now = new Date();
                now.setHours(now.getHours() + 1);
                document.getElementById('scheduleTime').value = now.toTimeString().slice(0, 5);
                
                updateSchedulePreview();
            } else {
                section.style.display = 'none';
                sendButton.textContent = '📤 Send Now';
                scheduleInfo.style.display = 'none';
            }
        }

        function updateSchedulePreview() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const scheduleInfo = document.getElementById('scheduleInfo');
            const previewSpan = document.getElementById('schedulePreview');
            
            if (date && time) {
                const scheduledDateTime = new Date(`${date}T${time}`);
                const now = new Date();
                
                if (scheduledDateTime <= now) {
                    scheduleInfo.style.display = 'block';
                    scheduleInfo.style.background = '#f8d7da';
                    previewSpan.textContent = '⚠️ Scheduled time must be in the future';
                    return;
                }
                
                const timeUntil = getTimeUntil(scheduledDateTime);
                scheduleInfo.style.display = 'block';
                scheduleInfo.style.background = '#e3f2fd';
                previewSpan.textContent = `Message will be sent on ${scheduledDateTime.toLocaleDateString()} at ${scheduledDateTime.toLocaleTimeString()} (${timeUntil})`;
            } else {
                scheduleInfo.style.display = 'none';
            }
        }

        function getTimeUntil(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return `in ${days} day${days > 1 ? 's' : ''} and ${hours} hour${hours > 1 ? 's' : ''}`;
            if (hours > 0) return `in ${hours} hour${hours > 1 ? 's' : ''} and ${minutes} minute${minutes > 1 ? 's' : ''}`;
            return `in ${minutes} minute${minutes > 1 ? 's' : ''}`;
        }

        function updateTotalRecipients() {
            const checkboxes = document.querySelectorAll('#groupsSelection input[type="checkbox"]:checked');
            let total = 0;
            
            checkboxes.forEach(checkbox => {
                // Find the corresponding group
                const group = currentGroups.find(g => g.group_id === checkbox.value);
                if (group) {
                    total += group.member_count;
                }
            });
            
            document.getElementById('totalRecipients').textContent = total.toLocaleString();
        }

        function previewMessage() {
            const message = document.getElementById('bulkMessage').value;
            const preview = document.getElementById('messagePreview');
            const content = document.getElementById('previewContent');
            
            if (!message.trim()) {
                alert('Please enter a message to preview');
                return;
            }
            
            const previewHTML = `<p style="margin: 0; white-space: pre-wrap;">${message}</p>`;
            
            content.innerHTML = previewHTML;
            preview.style.display = 'block';
        }

        // Cancel scheduled message
        async function cancelScheduledMessage(messageId) {
            if (!confirm('Are you sure you want to cancel this scheduled message?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/scheduled_messages/${messageId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadScheduledMessages(); // Refresh list
                    loadEnhancedDashboardStats(); // Update stats
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error cancelling message:', error);
                alert('Error cancelling message');
            }
        }

        // Modal Functions
        function showBulkMessageModal() {
            loadGroupsForBulkMessage(); // Load latest groups
            document.getElementById('bulkMessageModal').style.display = 'block';
        }

        function closeBulkMessageModal() {
            document.getElementById('bulkMessageModal').style.display = 'none';
            document.getElementById('bulkMessageForm').reset();
            document.getElementById('messagePreview').style.display = 'none';
        }

        function showCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'block';
        }

        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'none';
            document.getElementById('createGroupForm').reset();
        }

        function showCreateTicketModal() {
            document.getElementById('createTicketModal').style.display = 'block';
        }

        function closeCreateTicketModal() {
            document.getElementById('createTicketModal').style.display = 'none';
            document.getElementById('createTicketForm').reset();
        }

        function showTestMessageModal() {
            document.getElementById('testMessageModal').style.display = 'block';
        }

        function closeTestMessageModal() {
            document.getElementById('testMessageModal').style.display = 'none';
            document.getElementById('testMessageForm').reset();
            document.getElementById('testMessageResult').innerHTML = '';
        }

        function closeGroupDetailsModal() {
            document.getElementById('groupDetailsModal').style.display = 'none';
        }

        // Form Handlers
        document.getElementById('createGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('groupName').value,
                description: document.getElementById('groupDescription').value,
                group_type: document.getElementById('groupType').value,
                constituency: document.getElementById('groupConstituency').value,
                region: document.getElementById('groupRegion').value
            };
            
            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Group "${formData.name}" created successfully!`);
                    closeCreateGroupModal();
                    loadGroups();
                    loadGroupOptions();
                    loadEnhancedDashboardStats();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Error creating group');
            }
        });

        document.getElementById('createTicketForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('ticketTitle').value;
            const message = document.getElementById('ticketMessage').value;
            const priority = document.getElementById('ticketPriority').value;
            const sender = document.getElementById('ticketSender').value;
            
            try {
                const response = await fetch('/api/create_ticket', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title, message, priority, sender })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    closeCreateTicketModal();
                    loadTickets();
                    loadEnhancedDashboardStats();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating ticket:', error);
                alert('Error creating ticket');
            }
        });

        document.getElementById('testMessageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = document.getElementById('testMessageText').value;
            const sender = document.getElementById('testSender').value;
            
            const resultDiv = document.getElementById('testMessageResult');
            resultDiv.innerHTML = '<div class="loading"></div> Analyzing message...';
            
            try {
                const response = await fetch('/api/simulate_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message, sender })
                });
                
                const result = await response.json();
                
                let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">';
                
                // Sentiment Analysis
                html += `<h4>📊 Sentiment Analysis</h4>`;
                html += `<p><strong>Sentiment:</strong> ${result.sentiment.sentiment}</p>`;
                html += `<p><strong>Confidence:</strong> ${(result.sentiment.confidence * 100).toFixed(1)}%</p>`;
                html += `<p><strong>Language:</strong> ${result.sentiment.language}</p>`;
                
                // Flagging Results
                html += `<h4>🚨 Content Flagging</h4>`;
                if (result.flagging.is_flagged) {
                    html += `<p><strong>Status:</strong> <span class="priority-badge priority-${result.flagging.priority.toLowerCase()}">FLAGGED - ${result.flagging.priority}</span></p>`;
                    html += `<p><strong>Category:</strong> ${result.flagging.category}</p>`;
                    html += `<p><strong>Reasons:</strong></p><ul>`;
                    result.flagging.reasons.forEach(reason => {
                        html += `<li>${reason.type}: ${reason.detail}</li>`;
                    });
                    html += `</ul>`;
                } else {
                    html += `<p><strong>Status:</strong> <span class="status-badge status-resolved">NOT FLAGGED</span></p>`;
                }
                
                // Ticket Creation
                if (result.ticket_created) {
                    html += `<h4>🎫 Ticket Created</h4>`;
                    html += `<p><strong>Ticket ID:</strong> ${result.ticket_created}</p>`;
                    html += `<p>A CRITICAL ticket has been automatically created for this message.</p>`;
                }
                
                // Auto Response
                if (result.auto_response) {
                    html += `<h4>🤖 Auto Response</h4>`;
                    html += `<p>${result.auto_response}</p>`;
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
                // Refresh data if ticket was created
                if (result.ticket_created) {
                    loadTickets();
                    loadEnhancedDashboardStats();
                }
                
            } catch (error) {
                console.error('Error testing message:', error);
                resultDiv.innerHTML = '<p style="color: red;">Error analyzing message</p>';
            }
        });

        // Enhanced bulk message form handler with scheduling
        document.getElementById('bulkMessageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = document.getElementById('bulkMessage').value;
            const checkboxes = document.querySelectorAll('#groupsSelection input[type="checkbox"]:checked');
            const groups = Array.from(checkboxes).map(cb => cb.value);
            
            const isScheduled = document.getElementById('scheduleToggle').checked;
            const useWhatsApp = document.getElementById('useWhatsAppAPI').checked;
            
            if (groups.length === 0) {
                alert('Please select at least one group');
                return;
            }
            
            // Prepare request data
            const requestData = {
                message: message,
                groups: groups,
                use_whatsapp: useWhatsApp,
                is_scheduled: isScheduled
            };
            
            // Add scheduling data if scheduled
            if (isScheduled) {
                const scheduleDate = document.getElementById('scheduleDate').value;
                const scheduleTime = document.getElementById('scheduleTime').value;
                
                if (!scheduleDate || !scheduleTime) {
                    alert('Please select both date and time for scheduling');
                    return;
                }
                
                // Validate future time
                const scheduledDateTime = new Date(`${scheduleDate}T${scheduleTime}`);
                if (scheduledDateTime <= new Date()) {
                    alert('Scheduled time must be in the future');
                    return;
                }
                
                requestData.schedule_date = scheduleDate;
                requestData.schedule_time = scheduleTime;
            }
            
            try {
                // Show loading state
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<div class="loading"></div> Processing...';
                submitButton.disabled = true;
                
                const response = await fetch('/api/bulk_message_enhanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (isScheduled) {
                        alert(`✅ Message scheduled successfully!\n\nScheduled for: ${result.scheduled_for}\nScheduled ID: ${result.scheduled_id}`);
                        loadScheduledMessages(); // Refresh scheduled messages list
                    } else {
                        alert(result.message);
                        loadBulkMessageHistory(); // Refresh bulk message history
                    }
                    
                    closeBulkMessageModal();
                    document.getElementById('bulkMessageForm').reset();
                    
                    // Reset UI states
                    document.getElementById('scheduleToggle').checked = false;
                    toggleScheduling();
                    updateTotalRecipients();
                    
                } else {
                    alert('Error: ' + result.error);
                }
                
                // Restore button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
                
                // Restore button state
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // Test Message (alternative method for messages section)
        async function testMessage() {
            const message = document.getElementById('testMessage').value;
            if (!message.trim()) {
                alert('Please enter a message to test');
                return;
            }
            
            const resultDiv = document.getElementById('messageTestResult');
            resultDiv.innerHTML = '<div class="loading"></div> Analyzing message...';
            
            try {
                const response = await fetch('/api/flag_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message })
                });
                
                const result = await response.json();
                
                let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">';
                html += `<h4>🔍 Analysis Results</h4>`;
                
                if (result.is_flagged) {
                    html += `<p><strong>Status:</strong> <span class="priority-badge priority-${result.priority.toLowerCase()}">FLAGGED - ${result.priority}</span></p>`;
                    html += `<p><strong>Category:</strong> ${result.category}</p>`;
                    html += `<p><strong>Response Time:</strong> ${result.priority_info.response_time}</p>`;
                    
                    if (result.reasons && result.reasons.length > 0) {
                        html += `<p><strong>Flagging Reasons:</strong></p><ul>`;
                        result.reasons.forEach(reason => {
                            html += `<li>${reason.type}: ${reason.detail}</li>`;
                        });
                        html += `</ul>`;
                    }
                } else {
                    html += `<p><strong>Status:</strong> <span class="status-badge status-resolved">NOT FLAGGED</span></p>`;
                    html += `<p>This message does not contain concerning content.</p>`;
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error testing message:', error);
                resultDiv.innerHTML = '<p style="color: red;">Error analyzing message</p>';
            }
        }

        // Utility Functions
        function refreshData() {
            loadEnhancedDashboardStats();
            loadRecentFlagged();
            loadTickets();
            loadBulkMessageHistory();
            loadScheduledMessages();
            loadAnalyticsSummary();
            loadGroups();
            alert('Data refreshed successfully!');
        }

        // Event listeners
        document.getElementById('scheduleDate').addEventListener('change', updateSchedulePreview);
        document.getElementById('scheduleTime').addEventListener('change', updateSchedulePreview);
        document.getElementById('bulkMessage').addEventListener('input', function() {
            const charCount = this.value.length;
            document.getElementById('charCount').textContent = charCount;
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            loadEnhancedDashboardStats();
            loadRecentFlagged();
            
            // Refresh scheduled messages if that section is active
            const scheduledSection = document.getElementById('scheduled');
            if (scheduledSection && scheduledSection.classList.contains('active')) {
                loadScheduledMessages();
            }
        }, 30000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
            
            // Ctrl+R to refresh data
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
        });

        // Initialize data loading when page loads
        loadGroupsForBulkMessage();
    </script>
</body>
</html>
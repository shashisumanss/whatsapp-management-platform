<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Real-time Connection Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .setup-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 30px auto;
            max-width: 1200px;
            padding: 40px;
        }
        
        .option-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-height: 200px;
        }
        
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .option-card.official {
            border-left: 5px solid #25d366;
        }
        
        .option-card.unofficial {
            border-left: 5px solid #ff9800;
        }
        
        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-official {
            background: #25d366;
            color: white;
        }
        
        .badge-unofficial {
            background: #ff9800;
            color: white;
        }
        
        .pros-cons {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .setup-steps {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .connection-status {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-connecting { background: #ffc107; animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .hidden { display: none; }
        
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .qr-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }

        #qrCodeImage {
            max-width: 256px;
            max-height: 256px;
            border: 3px solid #25d366;
            border-radius: 10px;
            margin: 10px 0;
        }

        .action-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-whatsapp {
            background: #25d366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #1ea952;
            color: white;
        }

        .btn-api {
            background: #ff9800;
            color: white;
        }

        .btn-api:hover {
            background: #e68900;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="setup-container">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-dark">
                    <i class="fab fa-whatsapp me-3" style="color: #25d366;"></i>
                    WhatsApp Real-time Setup
                </h1>
                <p class="lead text-muted">Choose your preferred method to connect WhatsApp for real-time message monitoring</p>
            </div>

            <!-- Connection Status -->
            <div class="connection-status">
                <h5><i class="fas fa-wifi me-2"></i>Connection Status</h5>
                <div id="connectionStatus">
                    <span class="status-indicator status-disconnected"></span>
                    Not connected - Please select a connection method below
                </div>
            </div>

            <!-- Integration Options -->
            <div class="row">
                <!-- WhatsApp Web Option -->
                <div class="col-md-6">
                    <div class="option-card official" onclick="selectOption('whatsapp-web')">
                        <div class="status-badge badge-official">OFFICIAL</div>
                        <h4><i class="fab fa-whatsapp me-2"></i>WhatsApp Web</h4>
                        <p class="text-muted">Connect using WhatsApp's official web interface</p>
                        
                        <div class="pros-cons">
                            <h6 class="text-success"><i class="fas fa-check-circle me-2"></i>Pros:</h6>
                            <ul class="mb-3">
                                <li>Official WhatsApp interface</li>
                                <li>Secure and reliable</li>
                                <li>Easy QR code setup</li>
                                <li>Real-time message sync</li>
                            </ul>
                            
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Limitations:</h6>
                            <ul class="mb-0">
                                <li>Requires phone to be online</li>
                                <li>Session expires periodically</li>
                                <li>Limited API access</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Business API Option -->
                <div class="col-md-6">
                    <div class="option-card unofficial" onclick="selectOption('business-api')">
                        <div class="status-badge badge-unofficial">ADVANCED</div>
                        <h4><i class="fas fa-cloud me-2"></i>Business API</h4>
                        <p class="text-muted">Enterprise-grade WhatsApp Business API integration</p>
                        
                        <div class="pros-cons">
                            <h6 class="text-success"><i class="fas fa-check-circle me-2"></i>Pros:</h6>
                            <ul class="mb-3">
                                <li>No phone dependency</li>
                                <li>Bulk messaging capabilities</li>
                                <li>Advanced automation</li>
                                <li>Enterprise features</li>
                            </ul>
                            
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Requirements:</h6>
                            <ul class="mb-0">
                                <li>WhatsApp Business verification</li>
                                <li>API credentials required</li>
                                <li>May require approval</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Setup Steps for Selected Option -->
            <div id="whatsapp-web-setup" class="hidden">
                <div class="setup-steps">
                    <h5><i class="fab fa-whatsapp me-2"></i>WhatsApp Web Setup</h5>
                    <ol>
                        <li>Click "Start WhatsApp Web Connection" below</li>
                        <li>A QR code will appear on this page</li>
                        <li>Open WhatsApp on your phone</li>
                        <li>Go to Settings â†’ Linked Devices</li>
                        <li>Tap "Link a Device" and scan the QR code</li>
                        <li>Your messages will sync automatically!</li>
                    </ol>
                    
                    <div class="text-center mt-3">
                        <button class="btn action-btn btn-whatsapp" onclick="startWhatsAppWeb()">
                            <i class="fas fa-qrcode me-2"></i>Start WhatsApp Web Connection
                        </button>
                        <a href="https://web.whatsapp.com" target="_blank" class="btn action-btn btn-outline-success">
                            <i class="fas fa-external-link-alt me-2"></i>Open WhatsApp Web Directly
                        </a>
                    </div>
                </div>

                <!-- QR Code Display Area -->
                <div id="qrCodeSection" class="hidden">
                    <div class="qr-container">
                        <h6><i class="fas fa-qrcode me-2"></i>Scan this QR Code with WhatsApp</h6>
                        <img id="qrCodeImage" src="" alt="QR Code will appear here" />
                        <div class="mt-3">
                            <button class="btn action-btn btn-outline-primary" onclick="refreshQR()">
                                <i class="fas fa-sync me-2"></i>Refresh QR Code
                            </button>
                        </div>
                        <div class="alert alert-info mt-3">
                            <strong>Instructions:</strong> Open WhatsApp â†’ Settings â†’ Linked Devices â†’ Link a Device â†’ Scan this code
                        </div>
                    </div>
                </div>
            </div>

            <div id="business-api-setup" class="hidden">
                <div class="setup-steps">
                    <h5><i class="fas fa-cloud me-2"></i>Business API Setup</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Setup Requirements:</h6>
                            <ul>
                                <li>WhatsApp Business Account</li>
                                <li>Verified business profile</li>
                                <li>API access credentials</li>
                                <li>Webhook URL configuration</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Configuration Steps:</h6>
                            <ol>
                                <li>Obtain WhatsApp Business API access</li>
                                <li>Configure webhook endpoints</li>
                                <li>Set up authentication tokens</li>
                                <li>Test connection and messaging</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn action-btn btn-api" onclick="setupBusinessAPI()">
                            <i class="fas fa-cog me-2"></i>Configure Business API
                        </button>
                        <button class="btn action-btn btn-outline-info" onclick="showAPIDocumentation()">
                            <i class="fas fa-book me-2"></i>View API Documentation
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="setupResults" class="mt-4"></div>

            <!-- Dashboard Links -->
            <div class="text-center mt-5 pt-4 border-top">
                <h5>Platform Management</h5>
                <p class="text-muted">Access your WhatsApp management tools</p>
                <a href="/management" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-tachometer-alt me-2"></i>Management Dashboard
                </a>
                <a href="/realtime" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-chart-line me-2"></i>Real-time Analytics
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedOption = null;
        let qrRefreshInterval = null;

        function selectOption(option) {
            selectedOption = option;
            
            // Update UI
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Hide all setup sections
            document.getElementById('whatsapp-web-setup').classList.add('hidden');
            document.getElementById('business-api-setup').classList.add('hidden');
            
            // Show selected setup section
            document.getElementById(option + '-setup').classList.remove('hidden');
            
            // Update connection status
            updateConnectionStatus('Option selected: ' + (option === 'whatsapp-web' ? 'WhatsApp Web' : 'Business API'));
        }

        function updateConnectionStatus(message, type = 'info') {
            const statusDiv = document.getElementById('connectionStatus');
            let indicator = 'status-disconnected';
            
            if (type === 'connected') indicator = 'status-connected';
            else if (type === 'connecting') indicator = 'status-connecting';
            
            statusDiv.innerHTML = `<span class="status-indicator ${indicator}"></span>${message}`;
        }

        function startWhatsAppWeb() {
            updateConnectionStatus('Connecting to WhatsApp Web...', 'connecting');
            
            // Start WhatsApp Web session
            fetch('/api/whatsapp/start/web', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateConnectionStatus('WhatsApp Web session started. Generating QR code...', 'connecting');
                        setTimeout(loadQRCode, 3000);
                    } else {
                        updateConnectionStatus('Failed to start WhatsApp Web: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    updateConnectionStatus('Connection error: ' + error.message, 'error');
                });
        }

        function loadQRCode() {
            fetch('/api/whatsapp/qr')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.qr_code) {
                        document.getElementById('qrCodeImage').src = 'data:image/png;base64,' + data.qr_code;
                        document.getElementById('qrCodeSection').classList.remove('hidden');
                        updateConnectionStatus('QR Code ready! Scan with your phone.', 'connecting');
                        
                        // Start checking for connection
                        startConnectionCheck();
                    } else if (data.connected) {
                        updateConnectionStatus('WhatsApp Web is already connected!', 'connected');
                        document.getElementById('qrCodeSection').classList.add('hidden');
                    } else {
                        updateConnectionStatus('QR Code not available. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    updateConnectionStatus('Failed to load QR code: ' + error.message, 'error');
                });
        }

        function refreshQR() {
            document.getElementById('qrCodeSection').classList.add('hidden');
            startWhatsAppWeb();
        }

        function startConnectionCheck() {
            qrRefreshInterval = setInterval(() => {
                fetch('/api/whatsapp/web-status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.connected) {
                            updateConnectionStatus('WhatsApp Web connected successfully!', 'connected');
                            document.getElementById('qrCodeSection').classList.add('hidden');
                            clearInterval(qrRefreshInterval);
                            showSuccessMessage();
                        }
                    })
                    .catch(error => console.log('Status check error:', error));
            }, 5000);
        }

        function setupBusinessAPI() {
            alert('Business API setup requires WhatsApp Business verification and API credentials. Please contact support for enterprise setup assistance.');
        }

        function showAPIDocumentation() {
            const docs = `
WhatsApp Business API Documentation:

Endpoints:
- POST /api/whatsapp/send - Send messages
- GET /api/whatsapp/web-status - Check connection
- POST /api/whatsapp/webhook - Receive messages
- GET /api/analytics - Get message analytics

Authentication:
- Bearer token required
- Contact support for API credentials

Rate Limits:
- 1000 messages per hour
- 100 API calls per minute
            `;
            alert(docs);
        }

        function showSuccessMessage() {
            document.getElementById('setupResults').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Connection Successful!</h5>
                    <p>WhatsApp is now connected to your management platform. All messages will be automatically analyzed for sentiment and flagged content.</p>
                    <div class="mt-3">
                        <a href="/management" class="btn btn-success me-2">View Dashboard</a>
                        <a href="/realtime" class="btn btn-outline-success">Real-time Monitor</a>
                    </div>
                </div>
            `;
        }

        // Auto-refresh QR code every 30 seconds if visible
        setInterval(() => {
            if (!document.getElementById('qrCodeSection').classList.contains('hidden')) {
                loadQRCode();
            }
        }, 30000);
    </script>
</body>
</html>

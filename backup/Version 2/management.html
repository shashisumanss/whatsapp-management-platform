<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Management Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: #666;
            font-size: 1rem;
        }

        .stat-card.critical .number { color: #e74c3c; }
        .stat-card.warning .number { color: #f39c12; }
        .stat-card.success .number { color: #27ae60; }
        .stat-card.info .number { color: #3498db; }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
            min-width: 140px;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: #667eea;
            color: white;
        }

        .action-btn.success {
            background: #27ae60;
            color: white;
        }

        .action-btn.warning {
            background: #f39c12;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Priority badges */
        .priority-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-critical { background: #ffe6e6; color: #c0392b; }
        .priority-high { background: #fff3e0; color: #d68910; }
        .priority-medium { background: #fff9e6; color: #b7950b; }
        .priority-low { background: #e8f5e8; color: #27ae60; }

        /* Status badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-open { background: #e3f2fd; color: #1976d2; }
        .status-resolved { background: #e8f5e8; color: #27ae60; }
        .status-pending { background: #fff3e0; color: #d68910; }
        .status-sending { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-cancelled { background: #f8f9fa; color: #6c757d; }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* Scheduling specific styles */
        .scheduling-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 10px;
        }

        .schedule-info {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading states */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üì± WhatsApp Management Platform</h1>
            <p>Enhanced messaging analysis and management system with scheduling</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card info">
                <div class="number" id="totalMessages">Loading...</div>
                <div class="label">Total Messages</div>
            </div>
            <div class="stat-card warning">
                <div class="number" id="flaggedMessages">Loading...</div>
                <div class="label">Flagged Messages</div>
            </div>
            <div class="stat-card critical">
                <div class="number" id="criticalMessages">Loading...</div>
                <div class="label">Critical Messages</div>
            </div>
            <div class="stat-card success">
                <div class="number" id="openTickets">Loading...</div>
                <div class="label">Open Tickets</div>
            </div>
            <div class="stat-card info">
                <div class="number" id="pendingScheduled">Loading...</div>
                <div class="label">Pending Scheduled</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection('messages')">üí¨ Messages</button>
            <button class="nav-tab" onclick="showSection('tickets')">üé´ Tickets</button>
            <button class="nav-tab" onclick="showSection('bulk')">üì¢ Bulk Messages</button>
            <button class="nav-tab" onclick="showSection('scheduled')">‚è∞ Scheduled</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <h2 class="section-title">üö® Recent Flagged Messages</h2>
            <div id="recentFlagged">Loading recent flagged messages...</div>

            <h2 class="section-title">‚ö° Quick Actions</h2>
            <div class="quick-actions">
                <button class="action-btn primary" onclick="window.open('/', '_blank')">
                    üìä View Sentiment Analysis
                </button>
                <button class="action-btn success" onclick="refreshData()">
                    üîÑ Refresh Data
                </button>
                <button class="action-btn warning" onclick="showBulkMessageModal()">
                    üì¢ Send Bulk Message
                </button>
                <button class="action-btn primary" onclick="showTestMessageModal()">
                    üß™ Test Message Analysis
                </button>
            </div>

            <!-- Analytics Summary -->
            <h2 class="section-title">üìà Analytics Summary</h2>
            <div id="analyticsSummary">Loading analytics...</div>
        </div>

        <!-- Messages Section -->
        <div id="messages" class="content-section">
            <h2 class="section-title">üí¨ Message Analysis</h2>
            <div class="form-group">
                <label for="testMessage">Test Message Flagging:</label>
                <textarea id="testMessage" class="form-control" placeholder="Enter a message to test the flagging system..."></textarea>
                <button class="action-btn primary" onclick="testMessage()" style="margin-top: 10px;">
                    üîç Analyze Message
                </button>
            </div>
            <div id="messageTestResult"></div>
        </div>

        <!-- Tickets Section -->
        <div id="tickets" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title">üé´ Ticket Management</h2>
                <button class="action-btn primary" onclick="showCreateTicketModal()">
                    ‚ûï Create Ticket
                </button>
            </div>
            <div id="ticketsList">Loading tickets...</div>
        </div>

        <!-- Bulk Messages Section -->
        <div id="bulk" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title">üì¢ Bulk Message History</h2>
                <button class="action-btn primary" onclick="showBulkMessageModal()">
                    üì§ Send New Message
                </button>
            </div>
            <div id="bulkMessageHistory">Loading bulk message history...</div>
        </div>

        <!-- Scheduled Messages Section -->
        <div id="scheduled" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title">‚è∞ Scheduled Messages</h2>
                <button class="action-btn primary" onclick="showBulkMessageModal()">
                    üìÖ Schedule New Message
                </button>
            </div>
            <div id="scheduledMessagesList">Loading scheduled messages...</div>
        </div>
    </div>

    <!-- Enhanced Bulk Message Modal with Scheduling -->
    <div id="bulkMessageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBulkMessageModal()">&times;</span>
            <h2>üì¢ Send Bulk Message</h2>
            <form id="bulkMessageForm">
                <div class="form-group">
                    <label for="bulkMessage">Message:</label>
                    <textarea id="bulkMessage" class="form-control" rows="4" placeholder="Enter your message here..." required></textarea>
                    <small class="text-muted">Character count: <span id="charCount">0</span>/1000</small>
                </div>

                <!-- Scheduling Section -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="scheduleToggle" onchange="toggleScheduling()">
                        <span>üìÖ Schedule for later</span>
                    </label>
                </div>

                <div id="schedulingSection" class="scheduling-section" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="scheduleDate">Date:</label>
                            <input type="date" id="scheduleDate" class="form-control" min="">
                        </div>
                        <div class="form-group">
                            <label for="scheduleTime">Time:</label>
                            <input type="time" id="scheduleTime" class="form-control">
                        </div>
                    </div>
                    <div class="schedule-info" id="scheduleInfo" style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 10px; display: none;">
                        <small><i class="fas fa-clock me-1"></i><span id="schedulePreview"></span></small>
                    </div>
                </div>

                <!-- Message Type Selection -->
                <div class="form-group">
                    <label>Message Type:</label>
                    <div style="display: flex; gap: 15px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="messageType" value="text" checked onchange="updateMessageType()">
                            üìù Text
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="messageType" value="image" onchange="updateMessageType()">
                            üñºÔ∏è Image
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="messageType" value="document" onchange="updateMessageType()">
                            üìÑ Document
                        </label>
                    </div>
                </div>

                <!-- Media Upload Section (hidden by default) -->
                <div id="mediaSection" class="form-group" style="display: none;">
                    <label for="mediaFile">Upload Media:</label>
                    <input type="file" id="mediaFile" class="form-control" accept="image/*,application/pdf,.doc,.docx">
                    <small class="text-muted">Supported: Images (JPG, PNG), Documents (PDF, DOC, DOCX)</small>
                </div>

                <!-- Target Selection -->
                <div class="form-group">
                    <label>Select Target Groups:</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                        <label><input type="checkbox" value="Community Group 1" checked onchange="updateTotalRecipients()"> 
                            <span style="margin-left: 8px;">üèòÔ∏è Community Group 1 <small>(1,250 members)</small></span>
                        </label>
                        <label><input type="checkbox" value="Emergency Alerts" checked onchange="updateTotalRecipients()"> 
                            <span style="margin-left: 8px;">üö® Emergency Alerts <small>(892 members)</small></span>
                        </label>
                        <label><input type="checkbox" value="Local Updates" checked onchange="updateTotalRecipients()"> 
                            <span style="margin-left: 8px;">üì¢ Local Updates <small>(567 members)</small></span>
                        </label>
                        <label><input type="checkbox" value="Health Notices" checked onchange="updateTotalRecipients()"> 
                            <span style="margin-left: 8px;">üè• Health Notices <small>(423 members)</small></span>
                        </label>
                        <label><input type="checkbox" value="Infrastructure Updates" checked onchange="updateTotalRecipients()"> 
                            <span style="margin-left: 8px;">üöß Infrastructure Updates <small>(334 members)</small></span>
                        </label>
                        <label><input type="checkbox" value="Public Announcements" checked onchange="updateTotalRecipients()"> 
                            <span style="margin-left: 8px;">üì£ Public Announcements <small>(789 members)</small></span>
                        </label>
                    </div>
                    <small class="text-muted">Total selected recipients: <span id="totalRecipients">4,255</span></small>
                </div>

                <!-- WhatsApp API Options -->
                <div class="form-group">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="useWhatsAppAPI" checked>
                            <span>üì± Use WhatsApp Business API</span>
                        </label>
                        <small class="text-muted">Enable for real message delivery with tracking and compliance</small>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" class="action-btn warning" onclick="previewMessage()" style="flex: 1;">
                        üëÅÔ∏è Preview
                    </button>
                    <button type="submit" class="action-btn primary" style="flex: 2;">
                        <span id="sendButtonText">üì§ Send Now</span>
                    </button>
                </div>
            </form>

            <!-- Preview Section -->
            <div id="messagePreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h5>üì± Message Preview:</h5>
                <div id="previewContent" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #25D366;"></div>
            </div>
        </div>
    </div>

    <!-- Create Ticket Modal -->
    <div id="createTicketModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateTicketModal()">&times;</span>
            <h2>üé´ Create New Ticket</h2>
            <form id="createTicketForm">
                <div class="form-group">
                    <label for="ticketTitle">Title:</label>
                    <input type="text" id="ticketTitle" class="form-control" placeholder="Brief description of the issue" required>
                </div>
                <div class="form-group">
                    <label for="ticketMessage">Description:</label>
                    <textarea id="ticketMessage" class="form-control" rows="4" placeholder="Detailed description of the issue" required></textarea>
                </div>
                <div class="form-group">
                    <label for="ticketPriority">Priority:</label>
                    <select id="ticketPriority" class="form-control">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                        <option value="CRITICAL">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ticketSender">Reporter:</label>
                    <input type="text" id="ticketSender" class="form-control" placeholder="Name of the person reporting" required>
                </div>
                <button type="submit" class="action-btn primary" style="width: 100%; margin-top: 20px;">
                    üé´ Create Ticket
                </button>
            </form>
        </div>
    </div>

    <!-- Test Message Modal -->
    <div id="testMessageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTestMessageModal()">&times;</span>
            <h2>üß™ Test Message Analysis</h2>
            <form id="testMessageForm">
                <div class="form-group">
                    <label for="testMessageText">Message:</label>
                    <textarea id="testMessageText" class="form-control" rows="3" placeholder="Enter a message to test..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="testSender">Sender:</label>
                    <input type="text" id="testSender" class="form-control" placeholder="Sender name" value="Test User">
                </div>
                <button type="submit" class="action-btn primary" style="width: 100%; margin-top: 20px;">
                    üîç Analyze Message
                </button>
            </form>
            <div id="testMessageResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStatsWithScheduling();
            loadRecentFlagged();
            loadTickets();
            loadBulkMessageHistory();
            loadScheduledMessages();
            loadAnalyticsSummary();
        });

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load data for specific sections
            if (sectionName === 'tickets') {
                loadTickets();
            } else if (sectionName === 'bulk') {
                loadBulkMessageHistory();
            } else if (sectionName === 'scheduled') {
                loadScheduledMessages();
            }
        }

        // Enhanced Dashboard Stats with Scheduling
        async function loadDashboardStatsWithScheduling() {
            try {
                const response = await fetch('/api/dashboard_stats_with_scheduling');
                const data = await response.json();
                
                document.getElementById('totalMessages').textContent = data.total_messages;
                document.getElementById('flaggedMessages').textContent = data.flagged_messages;
                document.getElementById('criticalMessages').textContent = data.critical_messages;
                document.getElementById('openTickets').textContent = data.open_tickets;
                document.getElementById('pendingScheduled').textContent = data.pending_scheduled || 0;
                
                currentData.stats = data;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                document.getElementById('totalMessages').textContent = '0';
                document.getElementById('flaggedMessages').textContent = '0';
                document.getElementById('criticalMessages').textContent = '0';
                document.getElementById('openTickets').textContent = '0';
                document.getElementById('pendingScheduled').textContent = '0';
            }
        }

        // Recent Flagged Messages
        async function loadRecentFlagged() {
            try {
                const response = await fetch('/api/recent_flagged');
                const flagged = await response.json();
                
                const container = document.getElementById('recentFlagged');
                
                if (flagged.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üòå</div>
                            <p>No flagged messages found. The system is monitoring for sensitive content.</p>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tickets.map(ticket => `
                                <tr>
                                    <td><strong>${ticket.id}</strong></td>
                                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${ticket.title}</td>
                                    <td>${ticket.category}</td>
                                    <td><span class="priority-badge priority-${ticket.priority.toLowerCase()}">${ticket.priority}</span></td>
                                    <td><span class="status-badge status-${ticket.status.toLowerCase()}">${ticket.status}</span></td>
                                    <td>${ticket.assigned_to}</td>
                                    <td>${new Date(ticket.created_at).toLocaleDateString()}</td>
                                    <td>
                                        ${ticket.status === 'OPEN' ? 
                                            `<button class="action-btn success" onclick="updateTicketStatus('${ticket.id}', 'RESOLVED')" style="padding: 5px 10px; font-size: 0.8rem;">‚úÖ Resolve</button>` :
                                            `<span style="color: #27ae60;">‚úÖ Resolved</span>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('ticketsList').innerHTML = '<p>Error loading tickets.</p>';
            }
        }

        // Update ticket status
        async function updateTicketStatus(ticketId, status) {
            try {
                const response = await fetch(`/api/tickets/${ticketId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: status })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadTickets(); // Reload tickets
                    loadDashboardStatsWithScheduling(); // Update stats
                } else {
                    alert('Error updating ticket status');
                }
            } catch (error) {
                console.error('Error updating ticket:', error);
                alert('Error updating ticket status');
            }
        }

        // Bulk Message History
        async function loadBulkMessageHistory() {
            try {
                const response = await fetch('/api/bulk_messages');
                const messages = await response.json();
                
                const container = document.getElementById('bulkMessageHistory');
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üì¢</div>
                            <p>No bulk messages sent yet. Use the "Send New Message" button to send your first bulk message.</p>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Message Preview</th>
                                <th>Groups</th>
                                <th>Status</th>
                                <th>Sent</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(msg => `
                                <tr>
                                    <td><strong>${msg.id}</strong></td>
                                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${msg.message}</td>
                                    <td>${msg.group_count || msg.recipient_count || 0} groups</td>
                                    <td><span class="status-badge status-${msg.status.toLowerCase()}">${msg.status}</span></td>
                                    <td>${msg.sent_count}/${msg.sent_count + (msg.failed_count || 0)}</td>
                                    <td>${new Date(msg.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading bulk messages:', error);
                document.getElementById('bulkMessageHistory').innerHTML = '<p>Error loading bulk message history.</p>';
            }
        }

        // Load Scheduled Messages
        async function loadScheduledMessages() {
            try {
                const response = await fetch('/api/scheduled_messages');
                const messages = await response.json();
                
                const container = document.getElementById('scheduledMessagesList');
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">‚è∞</div>
                            <p>No scheduled messages found. Use the "Schedule New Message" button to schedule your first message.</p>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Message Preview</th>
                                <th>Targets</th>
                                <th>Scheduled For</th>
                                <th>Status</th>
                                <th>Time Remaining</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(msg => `
                                <tr>
                                    <td><strong>${msg.id}</strong></td>
                                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${msg.message}</td>
                                    <td>${msg.total_targets} targets</td>
                                    <td>${new Date(msg.scheduled_for).toLocaleString()}</td>
                                    <td><span class="status-badge status-${msg.status}">${msg.status.toUpperCase()}</span></td>
                                    <td>${msg.time_remaining || '-'}</td>
                                    <td>
                                        ${msg.status === 'pending' ? 
                                            `<button class="action-btn warning" onclick="cancelScheduledMessage('${msg.id}')" style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">‚ùå Cancel</button>
                                             <button class="action-btn primary" onclick="rescheduleMessage('${msg.id}')" style="padding: 5px 10px; font-size: 0.8rem;">‚è∞ Reschedule</button>` :
                                            `<span style="color: #666;">No actions available</span>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading scheduled messages:', error);
                document.getElementById('scheduledMessagesList').innerHTML = '<p>Error loading scheduled messages.</p>';
            }
        }

        // Analytics Summary
        async function loadAnalyticsSummary() {
            try {
                const response = await fetch('/api/analytics/summary');
                const data = await response.json();
                
                const container = document.getElementById('analyticsSummary');
                
                const html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="stat-card">
                            <div class="number">${data.flagged_percentage}%</div>
                            <div class="label">Messages Flagged</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${Object.keys(data.sentiment_distribution || {}).length}</div>
                            <div class="label">Sentiment Types</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${Object.keys(data.language_distribution || {}).length}</div>
                            <div class="label">Languages Detected</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">${data.resolved_tickets}</div>
                            <div class="label">Resolved Tickets</div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('analyticsSummary').innerHTML = '<p>Error loading analytics summary.</p>';
            }
        }

        // Scheduling Functions
        function toggleScheduling() {
            const toggle = document.getElementById('scheduleToggle');
            const section = document.getElementById('schedulingSection');
            const sendButton = document.getElementById('sendButtonText');
            const scheduleInfo = document.getElementById('scheduleInfo');
            
            if (toggle.checked) {
                section.style.display = 'block';
                sendButton.textContent = '‚è∞ Schedule Message';
                
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('scheduleDate').min = today;
                
                // Set default time to 1 hour from now
                const now = new Date();
                now.setHours(now.getHours() + 1);
                document.getElementById('scheduleTime').value = now.toTimeString().slice(0, 5);
                
                updateSchedulePreview();
            } else {
                section.style.display = 'none';
                sendButton.textContent = 'üì§ Send Now';
                scheduleInfo.style.display = 'none';
            }
        }

        function updateSchedulePreview() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const scheduleInfo = document.getElementById('scheduleInfo');
            const previewSpan = document.getElementById('schedulePreview');
            
            if (date && time) {
                const scheduledDateTime = new Date(`${date}T${time}`);
                const now = new Date();
                
                if (scheduledDateTime <= now) {
                    scheduleInfo.style.display = 'block';
                    scheduleInfo.style.background = '#f8d7da';
                    previewSpan.textContent = '‚ö†Ô∏è Scheduled time must be in the future';
                    return;
                }
                
                const timeUntil = getTimeUntil(scheduledDateTime);
                scheduleInfo.style.display = 'block';
                scheduleInfo.style.background = '#e3f2fd';
                previewSpan.textContent = `Message will be sent on ${scheduledDateTime.toLocaleDateString()} at ${scheduledDateTime.toLocaleTimeString()} (${timeUntil})`;
            } else {
                scheduleInfo.style.display = 'none';
            }
        }

        function getTimeUntil(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return `in ${days} day${days > 1 ? 's' : ''} and ${hours} hour${hours > 1 ? 's' : ''}`;
            if (hours > 0) return `in ${hours} hour${hours > 1 ? 's' : ''} and ${minutes} minute${minutes > 1 ? 's' : ''}`;
            return `in ${minutes} minute${minutes > 1 ? 's' : ''}`;
        }

        function updateMessageType() {
            const messageType = document.querySelector('input[name="messageType"]:checked').value;
            const mediaSection = document.getElementById('mediaSection');
            const mediaFile = document.getElementById('mediaFile');
            
            if (messageType === 'text') {
                mediaSection.style.display = 'none';
                mediaFile.removeAttribute('required');
            } else {
                mediaSection.style.display = 'block';
                mediaFile.setAttribute('required', 'required');
                
                // Update file accept types based on message type
                if (messageType === 'image') {
                    mediaFile.accept = 'image/*';
                } else if (messageType === 'document') {
                    mediaFile.accept = 'application/pdf,.doc,.docx,.txt,.xlsx';
                }
            }
        }

        function updateCharCount() {
            const message = document.getElementById('bulkMessage').value;
            const charCount = document.getElementById('charCount');
            charCount.textContent = message.length;
            
            if (message.length > 800) {
                charCount.style.color = '#e74c3c';
            } else if (message.length > 600) {
                charCount.style.color = '#f39c12';
            } else {
                charCount.style.color = '#27ae60';
            }
        }

        function updateTotalRecipients() {
            const checkboxes = document.querySelectorAll('#bulkMessageForm input[type="checkbox"]:checked');
            let total = 0;
            
            checkboxes.forEach(checkbox => {
                if (checkbox.value !== 'undefined' && checkbox.id !== 'scheduleToggle' && checkbox.id !== 'useWhatsAppAPI') {
                    // Extract member count from label text
                    const label = checkbox.parentElement.textContent;
                    const match = label.match(/\((\d+,?\d*) members\)/);
                    if (match) {
                        total += parseInt(match[1].replace(',', ''));
                    }
                }
            });
            
            document.getElementById('totalRecipients').textContent = total.toLocaleString();
        }

        function previewMessage() {
            const message = document.getElementById('bulkMessage').value;
            const messageType = document.querySelector('input[name="messageType"]:checked').value;
            const preview = document.getElementById('messagePreview');
            const content = document.getElementById('previewContent');
            
            if (!message.trim()) {
                alert('Please enter a message to preview');
                return;
            }
            
            let previewHTML = '';
            
            if (messageType === 'text') {
                previewHTML = `<p style="margin: 0; white-space: pre-wrap;">${message}</p>`;
            } else {
                const mediaFile = document.getElementById('mediaFile').files[0];
                if (mediaFile) {
                    previewHTML = `
                        <div style="margin-bottom: 10px;">
                            <strong>üìé ${messageType.toUpperCase()}:</strong> ${mediaFile.name}
                        </div>
                        <p style="margin: 0; white-space: pre-wrap;">${message}</p>
                    `;
                } else {
                    previewHTML = `
                        <div style="margin-bottom: 10px; color: #e74c3c;">
                            <strong>‚ö†Ô∏è No ${messageType} file selected</strong>
                        </div>
                        <p style="margin: 0; white-space: pre-wrap;">${message}</p>
                    `;
                }
            }
            
            content.innerHTML = previewHTML;
            preview.style.display = 'block';
        }

        // Cancel scheduled message
        async function cancelScheduledMessage(messageId) {
            if (!confirm('Are you sure you want to cancel this scheduled message?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/scheduled_messages/${messageId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadScheduledMessages(); // Refresh list
                    loadDashboardStatsWithScheduling(); // Update stats
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error cancelling message:', error);
                alert('Error cancelling message');
            }
        }

        // Reschedule message
        async function rescheduleMessage(messageId) {
            const newDate = prompt('Enter new date (YYYY-MM-DD):');
            if (!newDate) return;
            
            const newTime = prompt('Enter new time (HH:MM):');
            if (!newTime) return;
            
            // Validate date format
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            const timeRegex = /^\d{2}:\d{2}$/;
            
            if (!dateRegex.test(newDate) || !timeRegex.test(newTime)) {
                alert('Invalid date or time format. Use YYYY-MM-DD for date and HH:MM for time.');
                return;
            }
            
            // Validate future time
            const newDateTime = new Date(`${newDate}T${newTime}`);
            if (newDateTime <= new Date()) {
                alert('New scheduled time must be in the future');
                return;
            }
            
            try {
                const response = await fetch(`/api/scheduled_messages/${messageId}/reschedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        schedule_date: newDate,
                        schedule_time: newTime
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadScheduledMessages(); // Refresh list
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error rescheduling message:', error);
                alert('Error rescheduling message');
            }
        }

        // Modal Functions
        function showBulkMessageModal() {
            document.getElementById('bulkMessageModal').style.display = 'block';
        }

        function closeBulkMessageModal() {
            document.getElementById('bulkMessageModal').style.display = 'none';
        }

        function showCreateTicketModal() {
            document.getElementById('createTicketModal').style.display = 'block';
        }

        function closeCreateTicketModal() {
            document.getElementById('createTicketModal').style.display = 'none';
        }

        function showTestMessageModal() {
            document.getElementById('testMessageModal').style.display = 'block';
        }

        function closeTestMessageModal() {
            document.getElementById('testMessageModal').style.display = 'none';
        }

        // Enhanced bulk message form handler with scheduling
        document.getElementById('bulkMessageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = document.getElementById('bulkMessage').value;
            const checkboxes = document.querySelectorAll('#bulkMessageForm input[type="checkbox"]:checked');
            const groups = Array.from(checkboxes)
                .filter(cb => cb.value !== 'undefined' && cb.id !== 'scheduleToggle' && cb.id !== 'useWhatsAppAPI')
                .map(cb => cb.value);
            
            const isScheduled = document.getElementById('scheduleToggle').checked;
            const useWhatsApp = document.getElementById('useWhatsAppAPI').checked;
            const messageType = document.querySelector('input[name="messageType"]:checked').value;
            
            if (groups.length === 0) {
                alert('Please select at least one group');
                return;
            }
            
            // Prepare request data
            const requestData = {
                message: message,
                groups: groups,
                use_whatsapp: useWhatsApp,
                message_type: messageType,
                is_scheduled: isScheduled
            };
            
            // Add scheduling data if scheduled
            if (isScheduled) {
                const scheduleDate = document.getElementById('scheduleDate').value;
                const scheduleTime = document.getElementById('scheduleTime').value;
                
                if (!scheduleDate || !scheduleTime) {
                    alert('Please select both date and time for scheduling');
                    return;
                }
                
                // Validate future time
                const scheduledDateTime = new Date(`${scheduleDate}T${scheduleTime}`);
                if (scheduledDateTime <= new Date()) {
                    alert('Scheduled time must be in the future');
                    return;
                }
                
                requestData.schedule_date = scheduleDate;
                requestData.schedule_time = scheduleTime;
            }
            
            // Add media URL if applicable
            if (messageType !== 'text') {
                const mediaFile = document.getElementById('mediaFile').files[0];
                if (mediaFile) {
                    // In a real implementation, you'd upload the file first and get a URL
                    requestData.media_url = `https://example.com/uploads/${mediaFile.name}`;
                }
            }
            
            try {
                // Show loading state
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<div class="loading"></div> Processing...';
                submitButton.disabled = true;
                
                const response = await fetch('/api/bulk_message_enhanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (isScheduled) {
                        alert(`‚úÖ Message scheduled successfully!\n\nScheduled for: ${result.scheduled_for}\nScheduled ID: ${result.scheduled_id}`);
                        loadScheduledMessages(); // Refresh scheduled messages list
                    } else {
                        alert(result.message);
                        loadBulkMessageHistory(); // Refresh bulk message history
                    }
                    
                    closeBulkMessageModal();
                    document.getElementById('bulkMessageForm').reset();
                    
                    // Reset UI states
                    document.getElementById('scheduleToggle').checked = false;
                    toggleScheduling();
                    updateMessageType();
                    updateTotalRecipients();
                    
                } else {
                    alert('Error: ' + result.error);
                }
                
                // Restore button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
                
                // Restore button state
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // Form Handlers
        document.getElementById('createTicketForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('ticketTitle').value;
            const message = document.getElementById('ticketMessage').value;
            const priority = document.getElementById('ticketPriority').value;
            const sender = document.getElementById('ticketSender').value;
            
            try {
                const response = await fetch('/api/create_ticket', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title, message, priority, sender })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    closeCreateTicketModal();
                    document.getElementById('createTicketForm').reset();
                    loadTickets(); // Reload tickets
                    loadDashboardStatsWithScheduling(); // Update stats
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating ticket:', error);
                alert('Error creating ticket');
            }
        });

        document.getElementById('testMessageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = document.getElementById('testMessageText').value;
            const sender = document.getElementById('testSender').value;
            
            const resultDiv = document.getElementById('testMessageResult');
            resultDiv.innerHTML = '<div class="loading"></div> Analyzing message...';
            
            try {
                const response = await fetch('/api/simulate_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message, sender })
                });
                
                const result = await response.json();
                
                let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">';
                
                // Sentiment Analysis
                html += `<h4>üìä Sentiment Analysis</h4>`;
                html += `<p><strong>Sentiment:</strong> ${result.sentiment.sentiment}</p>`;
                html += `<p><strong>Confidence:</strong> ${(result.sentiment.confidence * 100).toFixed(1)}%</p>`;
                html += `<p><strong>Language:</strong> ${result.sentiment.language}</p>`;
                
                // Flagging Results
                html += `<h4>üö® Content Flagging</h4>`;
                if (result.flagging.is_flagged) {
                    html += `<p><strong>Status:</strong> <span class="priority-badge priority-${result.flagging.priority.toLowerCase()}">FLAGGED - ${result.flagging.priority}</span></p>`;
                    html += `<p><strong>Category:</strong> ${result.flagging.category}</p>`;
                    html += `<p><strong>Reasons:</strong></p><ul>`;
                    result.flagging.reasons.forEach(reason => {
                        html += `<li>${reason.type}: ${reason.detail}</li>`;
                    });
                    html += `</ul>`;
                } else {
                    html += `<p><strong>Status:</strong> <span class="status-badge status-resolved">NOT FLAGGED</span></p>`;
                }
                
                // Ticket Creation
                if (result.ticket_created) {
                    html += `<h4>üé´ Ticket Created</h4>`;
                    html += `<p><strong>Ticket ID:</strong> ${result.ticket_created}</p>`;
                    html += `<p>A CRITICAL ticket has been automatically created for this message.</p>`;
                }
                
                // Auto Response
                if (result.auto_response) {
                    html += `<h4>ü§ñ Auto Response</h4>`;
                    html += `<p>${result.auto_response}</p>`;
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
                // Refresh data if ticket was created
                if (result.ticket_created) {
                    loadTickets();
                    loadDashboardStatsWithScheduling();
                }
                
            } catch (error) {
                console.error('Error testing message:', error);
                resultDiv.innerHTML = '<p style="color: red;">Error analyzing message</p>';
            }
        });

        // Test Message (alternative method for messages section)
        async function testMessage() {
            const message = document.getElementById('testMessage').value;
            if (!message.trim()) {
                alert('Please enter a message to test');
                return;
            }
            
            const resultDiv = document.getElementById('messageTestResult');
            resultDiv.innerHTML = '<div class="loading"></div> Analyzing message...';
            
            try {
                const response = await fetch('/api/flag_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message })
                });
                
                const result = await response.json();
                
                let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">';
                html += `<h4>üîç Analysis Results</h4>`;
                
                if (result.is_flagged) {
                    html += `<p><strong>Status:</strong> <span class="priority-badge priority-${result.priority.toLowerCase()}">FLAGGED - ${result.priority}</span></p>`;
                    html += `<p><strong>Category:</strong> ${result.category}</p>`;
                    html += `<p><strong>Response Time:</strong> ${result.priority_info.response_time}</p>`;
                    
                    if (result.reasons && result.reasons.length > 0) {
                        html += `<p><strong>Flagging Reasons:</strong></p><ul>`;
                        result.reasons.forEach(reason => {
                            html += `<li>${reason.type}: ${reason.detail}</li>`;
                        });
                        html += `</ul>`;
                    }
                } else {
                    html += `<p><strong>Status:</strong> <span class="status-badge status-resolved">NOT FLAGGED</span></p>`;
                    html += `<p>This message does not contain concerning content.</p>`;
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error testing message:', error);
                resultDiv.innerHTML = '<p style="color: red;">Error analyzing message</p>';
            }
        }

        // Utility Functions
        function refreshData() {
            loadDashboardStatsWithScheduling();
            loadRecentFlagged();
            loadTickets();
            loadBulkMessageHistory();
            loadScheduledMessages();
            loadAnalyticsSummary();
            alert('Data refreshed successfully!');
        }

        // Event listeners
        document.getElementById('scheduleDate').addEventListener('change', updateSchedulePreview);
        document.getElementById('scheduleTime').addEventListener('change', updateSchedulePreview);
        document.getElementById('bulkMessage').addEventListener('input', updateCharCount);

        // Initialize
        updateTotalRecipients();

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            loadDashboardStatsWithScheduling();
            loadRecentFlagged();
            
            // Refresh scheduled messages if that section is active
            const scheduledSection = document.getElementById('scheduled');
            if (scheduledSection && scheduledSection.classList.contains('active')) {
                loadScheduledMessages();
            }
        }, 30000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
            
            // Ctrl+R to refresh data
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
        });

        // Show notifications for new flagged messages
        let lastFlaggedCount = 0;
        
        async function checkForNewFlags() {
            try {
                const response = await fetch('/api/dashboard_stats_with_scheduling');
                const data = await response.json();
                
                if (data.flagged_messages > lastFlaggedCount && lastFlaggedCount > 0) {
                    // Show notification for new flagged message
                    if (Notification.permission === 'granted') {
                        new Notification('New Flagged Message', {
                            body: `${data.flagged_messages - lastFlaggedCount} new message(s) have been flagged`,
                            icon: '/static/icon.png'
                        });
                    }
                }
                
                lastFlaggedCount = data.flagged_messages;
            } catch (error) {
                console.error('Error checking for new flags:', error);
            }
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Check for new flags every minute
        setInterval(checkForNewFlags, 60000);

        // Initialize flag count
        setTimeout(checkForNewFlags, 2000);
    </script>
</body>
</html>
                                <th>Message</th>
                                <th>Sender</th>
                                <th>Priority</th>
                                <th>Category</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${flagged.map(msg => `
                                <tr>
                                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${msg.message}</td>
                                    <td>${msg.sender}</td>
                                    <td><span class="priority-badge priority-${msg.priority.toLowerCase()}">${msg.priority}</span></td>
                                    <td>${msg.category}</td>
                                    <td>${msg.timestamp}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading recent flagged:', error);
                document.getElementById('recentFlagged').innerHTML = '<p>Error loading flagged messages.</p>';
            }
        }

        // Tickets Management
        async function loadTickets() {
            try {
                const response = await fetch('/api/tickets');
                const tickets = await response.json();
                
                const container = document.getElementById('ticketsList');
                
                if (tickets.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üé´</div>
                            <p>No tickets found. Create a ticket or analyze messages to generate automatic tickets.</p>
                        </div>
                    `;
                    return;
                }
                
                const html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                